<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²“å’ªè«‡å¿ƒå®¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #FDFCFB;
            background-image: linear-gradient(160deg, #FDFCFB 0%, #E2D1C3 100%);
        }
        /* Cat/Pastel Theme */
        :root {
            --bg-main: #F8F7FC; /* Light Lavender */
            --bg-secondary: #FFFFFF;
            --text-primary: #4A4A68; /* Dark Purple-Gray */
            --text-secondary: #8A8A9E; /* Medium Purple-Gray */
            --accent-primary: #A491D3; /* Lavender */
            --accent-primary-hover: #9279C5; /* Darker Lavender */
            --user-bubble: #F1EDF9; /* Very Light Lavender */
            --gemini-bubble: #FBFBFB; 
            --shadow-color: rgba(146, 121, 197, 0.1);
        }
        .transition-all { transition: all 0.3s ease-in-out; }
        .view-transition {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }
        .chat-bubble {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .dot-flashing {
            position: relative;
            width: 8px;
            height: 8px;
            border-radius: 5px;
            background-color: var(--accent-primary);
            color: var(--accent-primary);
            animation: dotFlashing 1s infinite linear alternate;
            animation-delay: .5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }
        .dot-flashing::before {
            left: -12px;
            width: 8px;
            height: 8px;
            border-radius: 5px;
            background-color: var(--accent-primary);
            color: var(--accent-primary);
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 12px;
            width: 8px;
            height: 8px;
            border-radius: 5px;
            background-color: var(--accent-primary);
            color: var(--accent-primary);
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 1s;
        }
        @keyframes dotFlashing {
            0% { background-color: var(--accent-primary); }
            50%, 100% { background-color: rgba(164, 145, 211, 0.2); }
        }
        .custom-shadow {
             box-shadow: 0 4px 10px -1px var(--shadow-color), 0 2px 8px -2px var(--shadow-color);
        }
        .custom-shadow-lg {
            box-shadow: 0 10px 20px -3px var(--shadow-color), 0 4px 8px -4px var(--shadow-color);
        }
        .card-paw-decoration {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='%23F1EDF9'%3E%3Cpath d='M65.2 55.8c-1.8-1.8-4.2-2.8-6.7-2.8s-4.9 1-6.7 2.8c-3.7 3.7-3.7 9.7 0 13.4 1.8 1.8 4.2 2.8 6.7 2.8s4.9-1 6.7-2.8c3.7-3.7 3.7-9.7 0-13.4zm19.5-19.5c-1.8-1.8-4.2-2.8-6.7-2.8s-4.9 1-6.7 2.8c-3.7 3.7-3.7 9.7 0 13.4 1.8 1.8 4.2 2.8 6.7 2.8s4.9-1 6.7-2.8c3.7-3.7 3.7-9.7 0-13.4zm-39 0c-1.8-1.8-4.2-2.8-6.7-2.8s-4.9 1-6.7 2.8c-3.7 3.7-3.7 9.7 0 13.4 1.8 1.8 4.2 2.8 6.7 2.8s4.9-1 6.7-2.8c3.7-3.7 3.7-9.7 0-13.4zm-19.5 19.5c-1.8-1.8-4.2-2.8-6.7-2.8s-4.9 1-6.7 2.8c-3.7 3.7-3.7 9.7 0 13.4 1.8 1.8 4.2 2.8 6.7 2.8s4.9-1 6.7-2.8c3.7-3.7 3.7-9.7 0-13.4zM50 0C22.4 0 0 22.4 0 50s22.4 50 50 50 50-22.4 50-50S77.6 0 50 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: top 0.5rem right 0.5rem;
            background-size: 4rem;
            position: relative;
        }
        textarea {
            resize: none;
            overflow-y: hidden;
        }

        /* GALING èª¿æ•´å–µå¥¶å¥¶é ­åƒ52px/48px 10/04 */
        .grandma-avatar, .reporter-avatar {
            width: 52px;
            height: 52px;
            border-radius: 9999px;
            object-fit: cover;
            flex-shrink: 0;
        }
        @media (max-width: 640px) {
            /* GALING èª¿æ•´å–µå¥¶å¥¶é ­åƒ52px/48px 10/04 */
            .grandma-avatar, .reporter-avatar {
                width: 48px;
                height: 48px;
            }
        }

        /* GALING 10/04 æŒ‰éˆ•å‹•ç•«çµ±ä¸€è¨­å®š */
        .paw-button {
            background: none;
            border: none;
            padding: 4px;
            line-height: 0;
            cursor: pointer;
            transition: transform 0.12s ease-in-out;
            flex-shrink: 0;
        }
        .paw-button:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        .paw-button[disabled] {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .send-icon {
            display: block;
            width: 40px;
            height: 40px;
            font-size: 32px;
            line-height: 40px;
            text-align: center;
        }
        .send-icon.paw {
            color: #A491D3;
        }
        .send-icon.mic {
            color: #FF9AA2;
        }
        .paw-button[disabled] .send-icon {
            color: #d5c8f0;
        }
        @keyframes bounce-stamp {
            0% { transform: translateY(0) scale(1); }
            30% { transform: translateY(6px) scale(0.9); }
            60% { transform: translateY(-3px) scale(1.06); }
            100% { transform: translateY(0) scale(1); }
        }
        .paw-button.is-sending .send-icon.paw {
            animation: bounce-stamp 0.6s ease-out 1;
        }
        .paw-button.is-sending .send-icon.mic {
            animation: spin 0.6s ease-out 1;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes grandma-avatar-pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 215, 99, 0.9); }
            70% { transform: scale(1.08); box-shadow: 0 0 0 14px rgba(255, 215, 99, 0); }
            100% { transform: scale(1); box-shadow: none; }
        }
        /* GALING è„ˆè¡å‹•ç•« 10-04 */
        .grandma-avatar.is-speaking, .reporter-avatar.is-speaking {
            animation: grandma-avatar-pulse 0.8s ease-out 1;
        }

        /* GALING 10/03 èŠå¤©æ–‡å­—èª¿æ•´ */
        .chat-message {
            font-size: 16px;
            line-height: 1.6;
        }
        @media (min-width: 768px) {
            .chat-message {
                font-size: 17px;
            }
        }

        /* GALING 10/02 å°è©±æ¡†å°ºå¯¸èª¿å¤§ */
        .chat-input-wrapper {
            width: min(100%, 420px);
            margin: 0 auto;
        }
        /* GALING 10/02 å°è©±æ¡†å°ºå¯¸èª¿å¤§ */
        #message-input, #send-button {
            min-height: 56px;
        }
        @media (min-width: 768px) {
            /* GALING 10/02 å°è©±æ¡†å°ºå¯¸èª¿å¤§ */
            #message-input, #send-button {
                min-height: 60px;
            }
        }
    </style>
</head>
<body class="text-[var(--text-primary)] flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-6xl mx-auto h-screen flex flex-col">

        <!-- Mode Selection View -->
        <div id="selection-view" class="flex flex-col items-center justify-center h-full view-transition">
            <div class="text-center mb-12">
                 <svg class="w-24 h-24 mx-auto text-purple-200 mb-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M15.5,14.5c-0.83,0-1.5-0.67-1.5-1.5s.67-1.5,1.5-1.5 s1.5,0.67,1.5,1.5S16.33,14.5,15.5,14.5z M8.5,14.5c-0.83,0-1.5-0.67-1.5-1.5s.67-1.5,1.5-1.5s1.5,0.67,1.5,1.5S9.33,14.5,8.5,14.5z M12,9.5C9.12,9.5,7.5,7.71,7.5,6C7.5,5.17,8.17,4.5,9,4.5c0.76,0,1.38,0.57,1.48,1.3c0.11,0.77,0.76,1.2,1.52,1.2s1.41-0.43,1.52-1.2 c0.1-0.73,0.72-1.3,1.48-1.3c0.83,0,1.5,0.67,1.5,1.5C16.5,7.71,14.88,9.5,12,9.5z"/></svg>
                <h1 class="text-4xl md:text-5xl font-bold mb-2">è²“å’ªè«‡å¿ƒå®¤</h1>
                <p class="text-lg text-[var(--text-secondary)]">é¸ä¸€ä½è²“å’ªæœ‹å‹ï¼Œé–‹å§‹ä½ å€‘çš„æ‚„æ‚„è©±æ™‚é–“ã€‚</p>
                <!-- ğŸŸ¢ ä¿®æ”¹é–‹å§‹ï¼šæä¾›é‡æ–°ä¸Šå‚³å¥æª¢å ±å‘Šå…¥å£ï¼ˆå¼·åŒ–å¤–è§€èˆ‡æ–°å¢è²“çˆª emojiï¼‰ -->
                <a href="{{ url_for('upload_health', reupload=1) }}" class="inline-flex items-center gap-4 mt-6 px-8 py-3.5 rounded-full text-base font-semibold text-gray-700 border border-transparent bg-white/90 shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all" style="font-size: 200%;">
                    <span class="flex items-center gap-3">ğŸ¾ æˆ‘è¦é‡æ–°ä¸Šå‚³å ±å‘Š</span>
                </a>
                <!-- ğŸŸ¢ ä¿®æ”¹çµæŸ -->
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-3xl">
                <button onclick="selectMode('deep-chat')" class="group bg-[var(--bg-secondary)] p-8 rounded-2xl custom-shadow-lg hover:shadow-2xl hover:-translate-y-1.5 transition-all text-left flex items-center gap-6">
                    <div class="bg-purple-100 p-4 rounded-full"><svg class="w-10 h-10 text-purple-500" viewBox="0 0 24 24" fill="currentColor"><path d="M19.78,11.73c-0.39-0.39-1.02-0.39-1.41,0l-0.09,0.09C17.91,12.2,17.5,12.5,17,12.5c-0.46,0-0.86-0.26-1.06-0.64 c-0.33-0.63-0.01-1.41,0.62-1.74l0.16-0.08c-0.12-0.53-0.30-1.04-0.54-1.51c-0.78-1.52-2.02-2.76-3.54-3.54 c-0.47-0.24-0.98-0.42-1.51-0.54l-0.08,0.16c-0.33,0.63-1.11,0.95-1.74,0.62C8.6,7.14,8.34,6.74,8.34,6.27 c0-0.50,0.30-0.91,0.69-1.27l0.09-0.09c0.39-0.39,0.39-1.02,0-1.41c-0.39-0.39-1.02-0.39-1.41,0l-0.09,0.09 C7.20,4,7,4.54,7,5c0,1.10,0.90,2,2,2c0.23,0,0.45-0.04,0.66-0.11L9.50,7.17C8.50,7.50,7.50,8.50,7.17,9.50L6.89,9.34 C6.96,9.13,7,8.90,7,8.67c0-1.10-0.90-2-2-2c-0.46,0-0.99,0.20-1.32,0.53L3.59,7.29C3.20,7.68,3.20,8.31,3.59,8.71z M15.29,3.59 c0.39-0.39,1.02-0.39,1.41,0l0.09,0.09C17.18,4,17.40,4.54,17.40,5c0,1.10-0.90,2-2,2c-0.23,0-0.45-0.04-0.66-0.11L14.50,7.17 c1,0.33,2,1.33,2.33,2.33l0.28-0.16C17.04,9.13,17,8.90,17,8.67c0-1.10,0.90-2,2-2c0.46,0,0.99,0.20,1.32,0.53l0.09,0.09 c0.39,0.39,1.02,0.39,1.41,0c0.39-0.39,0.39-1.02,0-1.41L21.71,3.59C21.32,3.20,20.78,3.20,20.39,3.59z M12,14c-2.21,0-4,1.79-4,4 s1.79,4,4,4s4-1.79,4-4S14.21,14,12,14z"/></svg></div>
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold">æ·±åº¦èŠèŠ</h2>
                        <!-- GALING ä¿®æ”¹æè¿°ä½ç½®+æ–°å¢ç¶½è™Ÿ 10/04 -->
                        <p class="text-[var(--text-secondary)] text-sm mt-2 leading-relaxed">è®“æº«æŸ”çš„ã€Œå–µå¥¶å¥¶æ˜¥è˜­ã€é™ªä½ æ·±å…¥æ¢ç´¢å…§å¿ƒä¸–ç•Œï¼Œæ…¢æ…¢æ¢³ç†æ€ç·’ï¼Œä½ å¯ä»¥å‚³é€ä»»ä½•æƒ³èŠçš„å¿ƒæƒ…è©±èªçµ¦å–µå¥¶å¥¶æ˜¥è˜­ï¼Œè‹¥æ„Ÿè¦ºèŠå¤ äº†ï¼Œå¯ä»¥æŒ‰ã€Œæ‚„æ‚„è©±ç¸½çµã€å™¢ï¼</p>
                    </div>
                </button>
                <button onclick="selectMode('quick-qa')" class="group bg-[var(--bg-secondary)] p-8 rounded-2xl custom-shadow-lg hover:shadow-2xl hover:-translate-y-1.5 transition-all text-left flex items-center gap-6">
                    <div class="bg-amber-100 p-4 rounded-full"><svg class="w-10 h-10 text-amber-500" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5,14h-0.79l-0.28-0.27c1.2-1.4,1.82-3.31,1.48-5.34c-0.47-2.78-2.79-5-5.59-5.34c-4.23-0.52-7.79,3.04-7.27,7.27 c0.34,2.8,2.56,5.12,5.34,5.59c2.03,0.34,3.94-0.28,5.34-1.48L14,14.47V15.5l5,5l1.5-1.5L15.5,14z M9.5,14C7.01,14,5,11.99,5,9.5 C5,7.01,7.01,5,9.5,5S14,7.01,14,9.5C14,11.99,11.99,14,9.5,14z"/></svg></div>
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold">ç„¦é»è¨ªè«‡</h2>
                        <!-- GALING ä¿®æ”¹æè¿°ä½ç½®+æ–°å¢ç¶½è™Ÿ 10/04 -->
                        <p class="text-[var(--text-secondary)] text-sm mt-2 leading-relaxed">ç”±å°ˆæ¥­çš„ã€Œå–µè¨˜è€…é¦¬å…‹ã€æå• 3 é¡Œè‡³ 15 é¡Œé¸æ“‡é¡Œï¼Œä½ å¯ä»¥ä¸‰é¸ä¸€ä½œç­”ï¼Œä¹Ÿå¯ä»¥æ”¹è¼¸å…¥æ–‡å­—å‚³é€ç­”æ¡ˆï¼›è‹¥æ„Ÿè¦ºèŠå¤ äº†å¯ä»¥æŒ‰ã€Œæ‚„æ‚„è©±ç¸½çµã€ï¼Œè®“é¦¬å…‹é™ªä½ å¿«é€Ÿé‡æ¸…ç•¶ä¸‹çš„å¿ƒæƒ…èˆ‡ç‹€æ³ã€‚</p>
                    </div>
                </button>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="hidden flex-col h-full view-transition opacity-0 scale-95 w-full">
            <header class="flex items-center mb-4">
                <button onclick="confirmReturnToMenu()" class="bg-gray-100 hover:bg-gray-200 text-gray-500 p-2 rounded-full transition-all mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                </button>
                <div class="flex-grow">
                    <h1 id="dashboard-title" class="text-xl font-bold text-slate-700">èˆ‡ å–µå¥¶å¥¶æ˜¥è˜­ æ·±åº¦èŠèŠ</h1>
                    <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-1.5 mt-1.5">
                        <div id="progress-bar-fill" class="bg-[var(--accent-primary)] h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </header>
            <main id="main-grid" class="grid grid-cols-1 gap-6 flex-grow min-h-0">
                <!-- Left: Chat Panel -->
                <div id="chat-panel" class="bg-[var(--bg-secondary)] rounded-2xl custom-shadow flex flex-col h-full max-h-[calc(100vh-120px)]">
                    <div id="chat-history" class="flex-grow p-4 space-y-4 overflow-y-auto scroll-smooth">
                        <!-- Messages will be injected here -->
                    </div>
                    <div id="quick-replies-container" class="p-2 flex flex-wrap gap-2 justify-center border-t border-gray-100">
                        <!-- Quick replies will be injected here -->
                    </div>
                    <div class="p-4 border-t border-gray-100">
                        <!-- GALING 10/02 å°è©±æ¡†å°ºå¯¸èª¿å¤§ -->
                        <div class="flex items-center gap-3 chat-input-wrapper w-full">
                            <!-- 10/02Galingä¿®æ”¹ è‡ªå‹•åµæ¸¬è£ç½® é›»è…¦/ç­†é›»Ctrl+Enteré€å‡º -->
                            <textarea id="message-input" rows="1" class="w-full p-3 border-gray-200 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)] transition-all" placeholder="èªªé»ä»€éº¼å§... æŒ‰å³é‚ŠæŒ‰éˆ•é€å‡ºè¨Šæ¯"></textarea>
                            <!-- GALING 10/03 è²“çˆªæŒ‰éˆ•å‹•ç•« -->
                            <button onclick="sendMessage()" class="paw-button" id="send-button" type="button" aria-label="é€å‡ºè¨Šæ¯">
                                <span id="send-icon" class="send-icon paw">ğŸ¾</span>
                            </button>
                        </div>
                    </div>
                    <!-- ğŸŸ¢ ä¿®æ”¹é–‹å§‹ï¼šèŠå¤©å®¤å…è²¬è²æ˜ -->
                    <div class="px-4 pb-4">
                        <div class="bg-amber-100 border border-amber-300 text-amber-900 rounded-xl px-4 py-3 text-xs text-center leading-relaxed">
                            <strong>ã€ç‰¹åˆ¥æé†’ã€‘</strong> æœ¬æ¸¬é©—åƒ…ç‚ºå¨›æ¨‚èˆ‡åƒè€ƒï¼Œä¸¦éé†«ç™‚å»ºè­°ã€‚è‹¥æœ‰ä»»ä½•èº«å¿ƒå›°æ“¾ï¼Œè«‹å°‹æ±‚å°ˆæ¥­å”åŠ©ã€‚
                        </div>
                    </div>
                    <!-- ğŸŸ¢ ä¿®æ”¹çµæŸ -->
                </div>
                <!-- Right: Dashboard Panel -->
                <div id="dashboard-panel" class="hidden rounded-2xl overflow-y-auto h-full max-h-[calc(100vh-120px)] space-y-6 scroll-smooth">
                    <div class="bg-white p-6 rounded-2xl custom-shadow card-paw-decoration">
                         <h3 class="font-semibold mb-2 text-slate-600 flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-400" viewBox="0 0 24 24" fill="currentColor"><path d="M14,2H6C4.9,2,4,2.9,4,4v16c0,1.1,0.9,2,2,2h12c1.1,0,2-0.9,2-2V8L14,2z M12,19c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3 S13.66,19,12,19z M15,9H9V4h6V9z"/></svg>
                            æ‚„æ‚„è©±ç¸½çµ
                        </h3>
                        <div id="report-summary" class="text-[var(--text-secondary)] text-sm prose max-w-none prose-p:my-1">å®Œæˆå°è©±å¾Œï¼Œé€™è£¡æœƒå‡ºç¾ä¸€ä»½æš–å¿ƒç¸½çµã€‚</div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-sm w-full transform transition-transform duration-300 scale-95">
            <h2 class="text-xl font-bold mb-4 text-slate-800">ç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ</h2>
            <p class="text-slate-600 mb-6">ç¾åœ¨é›¢é–‹çš„è©±ï¼Œé€™æ¬¡çš„å°è©±ç´€éŒ„æœƒæ¶ˆå¤±å–”ã€‚</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-return-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-5 rounded-lg hover:bg-gray-300 transition-all">ç¹¼çºŒèŠ</button>
                <button id="confirm-return-btn" class="bg-red-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-600 transition-all">ç¢ºå®šé›¢é–‹</button>
            </div>
        </div>
    </div>

    <!-- Result Notification Modal -->
    <div id="result-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-sm w-full text-center transform transition-transform duration-300 scale-95">
            <div class="mx-auto bg-purple-100 w-16 h-16 rounded-full flex items-center justify-center mb-4">
                <svg class="w-10 h-10 text-purple-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M16.71,9.29l-6.59,6.59c-0.39,0.39-1.02,0.39-1.41,0 L6,13.17c-0.39-0.39-0.39-1.02,0-1.41s1.02-0.39,1.41,0L9,12.36l5.88-5.88c0.39-0.39,1.02-0.39,1.41,0S17.1,8.9,16.71,9.29z"/></svg>
            </div>
            <h2 class="text-2xl font-bold mb-3 text-slate-800">æ‚„æ‚„è©±å·²å®Œæˆ âœ¨</h2>
            <p class="text-slate-600 mb-6">æˆ‘å·²ç¶“å°‡æˆ‘å€‘çš„å°è©±æ•´ç†å¥½äº†ï¼Œå¿«ä¾†çœ‹çœ‹å§ï¼</p>
            <button id="close-result-modal" class="bg-[var(--accent-primary)] text-white font-semibold py-2.5 px-8 rounded-lg hover:bg-[var(--accent-primary-hover)] transition-all w-full">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const healthReportData = {{ latest_health_report|tojson|default('null', true)|safe }};
        const selectionView = document.getElementById('selection-view');
        const dashboardView = document.getElementById('dashboard-view');
        const dashboardPanel = document.getElementById('dashboard-panel');
        const dashboardTitle = document.getElementById('dashboard-title');
        const chatHistory = document.getElementById('chat-history');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const sendIcon = document.getElementById('send-icon');
        const quickRepliesContainer = document.getElementById('quick-replies-container');
        const reportSummary = document.getElementById('report-summary');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmReturnBtn = document.getElementById('confirm-return-btn');
        const cancelReturnBtn = document.getElementById('cancel-return-btn');
        const resultModal = document.getElementById('result-modal');
        const closeResultModalBtn = document.getElementById('close-result-modal');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const chatPanel = document.getElementById('chat-panel');
        const mainGrid = document.getElementById('main-grid');

        // --- App State ---
        const appState = {
            mode: null,
            conversationHistory: [],
            isLoading: false,
            isAnalysisReady: false,
            isReportGenerated: false,
            turnCount: 0,
            confidence: 0
        };

        // --- Loading Messages ---
        const loadingMessages = {
            'deep-chat': ["å¥¶å¥¶æ­£åœ¨ç‚ºä½ æ³¡ä¸€æ¯ç†±èŒ¶...", "è®“æˆ‘æƒ³æƒ³... å“å‘€ï¼Œæ¯›ç·šçƒæ»¾åˆ°å“ªå»äº†ï¼Ÿ", "åˆ¥æ€¥ï¼Œæº«æš–çš„è©±èªéœ€è¦æ…¢æ…¢é†é‡€ã€‚"],
            'quick-qa': ["ç¨¿å­æ­£åœ¨å¿«é€Ÿç·¨è¼¯ä¸­ï¼", "ç¨å®¶æ¶ˆæ¯ï¼ä½ çš„å¿ƒæƒ…é ­æ¢å³å°‡ç™¼å¸ƒï¼", "æ­£åœ¨ç¢ºèªæ¶ˆæ¯ä¾†æºï¼Œè«‹ç¨å€™..."]
        };
        const PAW_STAMP_DURATION = 600; // GALING 10/04 ç™¼é€æŒ‰éˆ•å‹•ç•«æ™‚é–“ (ms)

        const GRANDMA_PULSE_DURATION = 800; // GALING 10/03 å–µå¥¶å¥¶è„ˆè¡å‹•ç•«æ™‚é–“ (ms)




        // GALING èª¿æ•´å–µå¥¶å¥¶é ­åƒå‹•ç•« 10/04
        const grandmaAvatarUrl = "{{ url_for('static', filename='grandma.jpg') }}";
        const reportAvatarUrl = "{{ url_for('static', filename='reporter.jpg') }}";


        // 10/02Galingä¿®æ”¹ è‡ªå‹•åµæ¸¬è£ç½® é›»è…¦/ç­†é›»Ctrl+Enteré€å‡º
        const DESKTOP_PLACEHOLDER_MESSAGE = "èªªé»ä»€éº¼å§... (Ctrl+Enter é€å‡º)";
        const MOBILE_PLACEHOLDER_MESSAGE = "èªªé»ä»€éº¼å§... æŒ‰å³é‚ŠæŒ‰éˆ•é€å‡ºè¨Šæ¯";
        let isDesktopDevice = false;
        let resolvedPlaceholderText = MOBILE_PLACEHOLDER_MESSAGE;

        // 10/02Galingä¿®æ”¹ è‡ªå‹•åµæ¸¬è£ç½® é›»è…¦/ç­†é›»Ctrl+Enteré€å‡º
        function detectDesktopDevice() {
            try {
                if (window.matchMedia && window.matchMedia("(pointer: fine)").matches && (!navigator.maxTouchPoints || navigator.maxTouchPoints <= 1)) {
                    return true;
                }
                if (navigator.maxTouchPoints && navigator.maxTouchPoints > 1) {
                    return false;
                }
                const ua = (navigator.userAgent || "").toLowerCase();
                if (/(android|iphone|ipad|mobile|tablet)/i.test(ua)) {
                    return false;
                }
                if (/(windows|macintosh|linux|x11)/i.test(ua)) {
                    return true;
                }
            } catch (error) {
                console.warn("Device detection failed", error);
            }
            return false;
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // 10/02Galingä¿®æ”¹ è‡ªå‹•åµæ¸¬è£ç½® é›»è…¦/ç­†é›»Ctrl+Enteré€å‡º
            isDesktopDevice = detectDesktopDevice();
            resolvedPlaceholderText = isDesktopDevice ? DESKTOP_PLACEHOLDER_MESSAGE : MOBILE_PLACEHOLDER_MESSAGE;
            messageInput.placeholder = resolvedPlaceholderText;

            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto';
                messageInput.style.height = (messageInput.scrollHeight) + 'px';
            });
            // Modal listeners
            confirmReturnBtn.addEventListener('click', () => {
                returnToMenu();
                hideConfirmModal();
            });
            cancelReturnBtn.addEventListener('click', hideConfirmModal);
            confirmModal.addEventListener('click', (e) => {
                if(e.target === confirmModal) hideConfirmModal();
            });
            closeResultModalBtn.addEventListener('click', () => {
                hideResultModal();
            });
            resultModal.addEventListener('click', (e) => {
                if(e.target === resultModal) {
                    hideResultModal();
                }
            });
        });

        // --- View & State Management ---
        function selectMode(mode) {
            appState.mode = mode;
            resetState();
            appState.qaQuestionCount = 0;
            appState.isMaxQaReached = false;
            appState.hasShownMaxQaReminder = false;

            dashboardTitle.textContent = mode === 'deep-chat' ? 'èˆ‡ å–µå¥¶å¥¶æ˜¥è˜­ æ·±åº¦èŠèŠ' : 'èˆ‡ å–µè¨˜è€…é¦¬å…‹ ç„¦é»è¨ªè«‡';
            if (sendIcon) {
                if (mode === 'deep-chat') {
                    sendIcon.textContent = 'ğŸ¾';
                    sendIcon.classList.remove('mic');
                    sendIcon.classList.add('paw');
                } else {
                    sendIcon.textContent = 'ğŸ™ï¸';
                    sendIcon.classList.remove('paw');
                    sendIcon.classList.add('mic');
                }
            }

            selectionView.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                selectionView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                setTimeout(() => {
                    dashboardView.classList.remove('opacity-0', 'scale-95');
                    dashboardView.classList.add('flex');
                }, 50);
                startConversation();
            }, 400);
        }

        function returnToMenu() {
            dashboardView.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                dashboardView.classList.add('hidden');
                dashboardView.classList.remove('flex');
                selectionView.classList.remove('hidden');
                setTimeout(() => {
                    selectionView.classList.remove('opacity-0', 'scale-95');
                }, 50);
                resetState();
                resetUI();
            }, 400);
        }
        
        function confirmReturnToMenu() {
            if (appState.conversationHistory.length > 0) {
                showConfirmModal();
            } else {
                returnToMenu();
            }
        }

        function showConfirmModal() {
            confirmModal.classList.remove('hidden');
            setTimeout(() => {
                confirmModal.classList.remove('opacity-0');
                confirmModal.querySelector('div').classList.remove('scale-95');
            }, 10);
        }

        function hideConfirmModal() {
            confirmModal.classList.add('opacity-0');
            confirmModal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                confirmModal.classList.add('hidden');
            }, 300);
        }

        function showResultModal() {
            resultModal.classList.remove('hidden');
            setTimeout(() => {
                resultModal.classList.remove('opacity-0');
                resultModal.querySelector('div').classList.remove('scale-95');
            }, 10);
        }

        function hideResultModal() {
            resultModal.classList.add('opacity-0');
            resultModal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                resultModal.classList.add('hidden');
                // é—œé–‰å½ˆçª—å¾Œé¡¯ç¤ºç¸½çµå…§å®¹
                showSummarySection();
            }, 300);
        }

        function showSummarySection() {
            // é¡¯ç¤º dashboard panel
            if (chatPanel && dashboardPanel) {
                chatPanel.classList.add('hidden');
                dashboardPanel.classList.remove('hidden');
                dashboardPanel.scrollIntoView({ behavior: 'smooth' });
            }
            
            // åœ¨ç¸½çµä¸‹æ–¹åŠ å…¥ç”Ÿæˆè²“å’ªåœ–å¡çš„æŒ‰éˆ•
            const summaryContainer = document.getElementById('report-summary').parentElement;
            
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰æŒ‰éˆ•ï¼Œé¿å…é‡è¤‡æ·»åŠ 
            if (!document.getElementById('generate-card-button')) {
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'mt-6 text-center';
                
                const generateCardBtn = document.createElement('button');
                generateCardBtn.id = 'generate-card-button';
                generateCardBtn.className = 'bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105';
                generateCardBtn.innerHTML = 'ğŸ± é»é¸æ­¤ç”¢ç”Ÿè²“å’ªåœ–å¡ âœ¨';
                generateCardBtn.onclick = () => {
                    window.location.href = "{{ url_for('generate_card') }}";
                };
                
                buttonContainer.appendChild(generateCardBtn);
                summaryContainer.appendChild(buttonContainer);
            }
        }
        
        function resetState() {
            Object.assign(appState, {
                conversationHistory: [], isLoading: false, isAnalysisReady: false,
                isReportGenerated: false, turnCount: 0, confidence: 0
            });
        }

        function resetUI() {
            chatHistory.innerHTML = '';
            messageInput.value = '';
            // 10/02Galingä¿®æ”¹ è‡ªå‹•åµæ¸¬è£ç½® é›»è…¦/ç­†é›»Ctrl+Enteré€å‡º
            messageInput.placeholder = resolvedPlaceholderText;
            quickRepliesContainer.innerHTML = '';
            reportSummary.textContent = 'å®Œæˆå°è©±å¾Œï¼Œé€™è£¡æœƒå‡ºç¾ä¸€ä»½æš–å¿ƒç¸½çµã€‚';
            updateProgressBar(0);

            if (sendIcon) {
                sendIcon.textContent = 'ğŸ¾';
                sendIcon.classList.remove('mic');
                sendIcon.classList.add('paw');
            }

            // ç§»é™¤ç”Ÿæˆè²“å’ªåœ–å¡æŒ‰éˆ•
            const existingButton = document.getElementById('generate-card-button');
            if (existingButton) {
                existingButton.parentElement.remove();
            }
            
            if (chatPanel && dashboardPanel) {
                chatPanel.classList.remove('hidden');
                dashboardPanel.classList.add('hidden');
            }
        }

        // --- Conversation Logic ---
        function startConversation() {
            const initialUserMessage = { role: 'user', parts: [{ text: "ä½ å¥½" }] };
            appState.conversationHistory.push(initialUserMessage);

            if (appState.mode === 'quick-qa') {
                const initialModelMessage = {
                    nextPrompt: "ä½ å¥½ï¼æˆ‘æ˜¯å–µè¨˜è€…é¦¬å…‹ï¼Œå°ä»€éº¼äº‹æ„Ÿåˆ°å¥½å¥‡å‘¢ï¼Ÿæˆ‘å€‘ä¾†èŠèŠå§ï¼",
                    quickReplies: ["å·¥ä½œ", "å¥åº·", "äººéš›é—œä¿‚"],
                };
                addMessage('gemini', initialModelMessage.nextPrompt);
                renderQuickReplies(initialModelMessage.quickReplies);
                appState.conversationHistory.push({ role: 'model', parts: [{ text: JSON.stringify(initialModelMessage) }] });

            } else {
                 addMessage('gemini', "å­©å­ï¼Œä½ å¥½å•Šã€‚æˆ‘æ˜¯å–µå¥¶å¥¶æ˜¥è˜­ï¼Œå¿ƒè£¡æœ‰ä»€éº¼äº‹ï¼Œéƒ½å¯ä»¥è·Ÿæˆ‘æ…¢æ…¢èªªã€‚");
                 appState.conversationHistory.push({ role: 'model', parts: [{ text: JSON.stringify({nextPrompt: "å­©å­ï¼Œä½ å¥½å•Šã€‚æˆ‘æ˜¯å–µå¥¶å¥¶æ˜¥è˜­ï¼Œå¿ƒè£¡æœ‰ä»€éº¼äº‹ï¼Œéƒ½å¯ä»¥è·Ÿæˆ‘æ…¢æ…¢èªªã€‚"}) }] });
            }
        }

        async function sendMessage(quickReplyText = null) {
            const text = quickReplyText || messageInput.value.trim();
            if (!text || appState.isLoading) return;

            sendButton.classList.add('is-sending');
            setTimeout(() => {
                sendButton.classList.remove('is-sending');
            }, PAW_STAMP_DURATION);

            addMessage('user', text);
            messageInput.value = '';
            messageInput.style.height = 'auto';
            clearQuickReplies();

            const explicitTriggerKeywords = ['ç¸½çµ', 'å›é¡§', 'å¹«æˆ‘ç¸½çµ', 'èŠå¤ äº†', 'å¯ä»¥ç¸½çµä¸€ä¸‹å—', 'é‚£æ¥ä¸‹ä¾†å‘¢', 'æˆ‘æ‡‰è©²æ€éº¼åš', 'æ€éº¼è¾¦', 'æ€éº¼åš', 'æˆ‘æº–å‚™å¥½ç¸½çµäº†'];
            const isExplicitTrigger = explicitTriggerKeywords.some(keyword => text.includes(keyword));

            if (isExplicitTrigger && !appState.isReportGenerated) {
                appState.isAnalysisReady = true;
                generateReport();
                return;
            }

            appState.conversationHistory.push({ role: 'user', parts: [{ text }] });
            appState.turnCount++;
            setLoading(true);

            try {
                const modelResponse = await callChatAPI(buildPrompt());
                handleModelResponse(modelResponse);
            } catch (error) {
                console.error("API Call Error:", error);
                addMessage('gemini', "å—š...æˆ‘å¥½åƒæœ‰é»æ–·ç·šäº†ï¼Œå¯ä»¥å†èªªä¸€æ¬¡å—ï¼Ÿ");
            } finally {
                setLoading(false);
            }
        }


        function handleModelResponse(response) {
            if(!response || !response.nextPrompt) {
                console.error("Invalid response from model:", response);
                addMessage('gemini', "æŠ±æ­‰ï¼Œæˆ‘å¥½åƒæœ‰é»è¿·ç³Šäº†ï¼Œå¯ä»¥å†å•ä¸€æ¬¡å—ï¼Ÿ");
                return;
            }

            appState.conversationHistory.push({ role: 'model', parts: [{ text: JSON.stringify(response) }] });
            addMessage('gemini', response.nextPrompt);
            
            let progress = 0;
            if (appState.mode === 'quick-qa') {
                appState.confidence = response.confidence_0_100 || appState.confidence;
                progress = appState.confidence;
                renderQuickReplies(response.quickReplies || []);
                if (appState.confidence >= 60 && !appState.isReportGenerated) {
                    renderGenerateReportButton();
                }

            } else { // deep-chat
                progress = Math.min(90, (appState.turnCount / 5) * 100); 
                 if (appState.turnCount >= 3 && !appState.isReportGenerated) {
                    renderGenerateReportButton();
                }
            }
            updateProgressBar(progress);
        }

        function renderGenerateReportButton() {
            if (document.getElementById('generate-report-btn')) return;

            const button = document.createElement('button');
            button.id = 'generate-report-btn';
            button.className = "w-full max-w-xs mx-auto my-2 bg-green-100 hover:bg-green-200 text-sm text-green-800 font-bold py-2 px-4 rounded-full transition-all border border-green-300 shadow-sm";
            button.textContent = "âœ¨æ‚„æ‚„è©±ç¸½çµ";
            button.onclick = () => {
                appState.isAnalysisReady = true;
                generateReport();
                clearQuickReplies();
            };
            quickRepliesContainer.appendChild(button);
        }

        async function generateReport() {
            if (appState.isReportGenerated) return;
            appState.isReportGenerated = true;
            setLoading(true, "æ­£åœ¨ç‚ºä½ æ•´ç†æ‚„æ‚„è©±...");
            updateProgressBar(100);

            try {
                const reportData = await callReportAPI();
                
                if (!reportData.emotionVector || 
                    typeof reportData.emotionVector.valence !== 'number' || 
                    typeof reportData.emotionVector.arousal !== 'number' || 
                    typeof reportData.emotionVector.dominance !== 'number') {
                    throw new Error("Invalid emotionVector structure received.");
                }

                // Frontend: Detect extreme/aggressive language in user messages
                const extremeKeywords = ['æ¨æ­»', 'æ¯€æ»…', 'çµ•æœ›', 'æš´åŠ›', 'æ®º', 'æ­»', 'ç—›æ¨', 'å´©æ½°', 'ç˜‹äº†'];
                let extremeCount = 0;
                const matchedKeywords = new Set();
                appState.conversationHistory
                    .filter(msg => msg.role === 'user')
                    .forEach(msg => {
                        const text = msg.parts[0].text.toLowerCase();
                        extremeKeywords.forEach(keyword => {
                            if (text.includes(keyword)) {
                                extremeCount++;
                                matchedKeywords.add(keyword);
                            }
                        });
                    });

                // Adjust emotionVector if extreme language detected
                let emotionVector = {
                    valence: reportData.emotionVector.valence,
                    arousal: reportData.emotionVector.arousal,
                    dominance: reportData.emotionVector.dominance
                };
                const deductAmount = extremeCount > 0 ? Math.min(30, extremeCount * 10) : 0;
                if (extremeCount > 0) {
                    emotionVector.valence -= deductAmount;
                    emotionVector.arousal += deductAmount;
                    emotionVector.dominance -= deductAmount;
                }

                // Validate and clamp to 1-100
                emotionVector = {
                    valence: Math.max(1, Math.min(100, Math.round(emotionVector.valence))),
                    arousal: Math.max(1, Math.min(100, Math.round(emotionVector.arousal))),
                    dominance: Math.max(1, Math.min(100, Math.round(emotionVector.dominance)))
                };

                const mindScore = Math.round(
                    (emotionVector.valence * 0.6) + 
                    (emotionVector.dominance * 0.3) + 
                    ((100 - Math.abs(emotionVector.arousal - 50)) * 0.1)
                );

                // Calculate bodyScore based on healthReportData
                let bodyScore;
                if (healthReportData && typeof healthReportData.health_score === 'number' && healthReportData.health_score >= 0 && healthReportData.health_score <= 100) {
                    bodyScore = healthReportData.health_score;
                } else {
                    const warnings = Array.isArray(healthReportData?.health_warnings) ? healthReportData.health_warnings.filter(Boolean) : [];
                    bodyScore = warnings.length > 0 ? Math.round(80 - (warnings.length * 5)) : 85;
                }

                const combinedScore = Math.round((mindScore + bodyScore) / 2);

                // Log scores to frontend console (for debugging)
                console.log('Generated Scores:', {
                    mindScore: Math.max(0, Math.min(100, mindScore)),
                    bodyScore: Math.max(0, Math.min(100, bodyScore)),
                    combinedScore: Math.max(0, Math.min(100, combinedScore)),
                    emotionVector: emotionVector,
                    extremeLanguage: {
                        detected: extremeCount > 0,
                        matchedKeywords: Array.from(matchedKeywords),
                        deductAmount: deductAmount
                    }
                });

                const finalReportData = {
                    ...reportData,
                    emotionVector,
                    summary: getSummaryPlainText(reportData.summary),
                    mindScore: Math.max(0, Math.min(100, mindScore)),
                    bodyScore: Math.max(0, Math.min(100, bodyScore)),
                    combinedScore: Math.max(0, Math.min(100, combinedScore)),
                    extremeLanguage: {
                        detected: extremeCount > 0,
                        matchedKeywords: Array.from(matchedKeywords),
                        deductAmount: deductAmount
                    }
                };

                // Save scores to backend
                try {
                    const response = await fetch('{{ url_for("save_psychology_scores") }}', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            mindScore: finalReportData.mindScore,
                            bodyScore: finalReportData.bodyScore,
                            combinedScore: finalReportData.combinedScore,
                            summary: finalReportData.summary,
                            keywords: finalReportData.keywords,
                            emotionVector: finalReportData.emotionVector,
                            conversationHistory: appState.conversationHistory,
                            extremeLanguage: finalReportData.extremeLanguage
                        })
                    });

                    if (!response.ok) {
                        const errorPayload = await response.json().catch(() => ({}));
                        throw new Error(errorPayload.error || `HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.error("Failed to save scores:", error);
                    addMessage('gemini', "ç´€éŒ„åˆ†æ•¸æ™‚é‡åˆ°å•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚");
                }

                displayReport(finalReportData);
            } catch (error) {
                console.error("Report Generation Error:", error);
                addMessage('gemini', "ç³Ÿç³•ï¼Œæ•´ç†çš„æ™‚å€™ä¸å°å¿ƒæŠŠå¢¨æ°´æ‰“ç¿»äº†ï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚");
                appState.isReportGenerated = false;
            } finally {
                setLoading(false);
            }
        }
        function updateProgressBar(percentage) {
            progressBarFill.style.width = `${Math.min(100, percentage)}%`;
        }

        // --- API & Prompting ---
        function buildPrompt() {
            let systemInstruction;
            
            if (appState.mode === 'deep-chat') {
                systemInstruction = `
                    ä½ çš„è§’è‰²: ä½ æ˜¯å€‹è¶…æ£’çš„å–µå¥¶å¥¶ï¼Œä½ èªªè©±å¾ˆæº«æŸ”ã€å¾ˆæœ‰åŒç†å¿ƒå–”ï¼
                    ä½ çš„ä»»å‹™:
                    1. æ¯æ¬¡å›è¦†å‰ï¼Œéƒ½è¦å…ˆç”¨ä¸€å¥è©±åŒç†ä¸€ä¸‹ä½¿ç”¨è€…ï¼Œä¾‹å¦‚ï¼šã€Œå–”ï½è½èµ·ä¾†ä½ å¥½åƒè¦ºå¾—...ã€
                    2. ç„¶å¾Œå†å•ä¸€å€‹é–‹æ”¾å¼å•é¡Œï¼Œè®“ä½¿ç”¨è€…èƒ½å¤šèªªä¸€äº›å¿ƒè£¡è©±ã€‚
                    3. èªæ°£è¦ä¸€ç›´ä¿æŒæš–å¿ƒåˆæ…ˆç¥¥ï¼
                    4. ä¸è¦è‡ªå·±æ±ºå®šä½•æ™‚çµæŸå°è©±ï¼Œä½¿ç”¨è€…æœƒé»æ“ŠæŒ‰éˆ•ä¾†ç”¢ç”Ÿå ±å‘Šã€‚
                    
                    å›å‚³æ ¼å¼ (å¿…é ˆæ˜¯åš´æ ¼çš„ JSON):
                    {
                      "nextPrompt": "ä½ çš„å›è¦†æ–‡å­—ã€‚",
                      "isAnalysisReady": false
                    }
                `;
            } else { // quick-qa
                const isFirstInteraction = appState.turnCount <= 1;
                if(isFirstInteraction) {
                     systemInstruction = `
                        ä½ çš„è§’è‰²: ä½ æ˜¯å€‹å°ˆæ¥­åˆå¥½å¥‡çš„å–µè¨˜è€…ã€‚
                        ä½ çš„ä»»å‹™ (åˆæ¬¡å°è©±):
                        1. æ ¹æ“šä½¿ç”¨è€…çš„ä¸»é¡Œé¸æ“‡ ("å·¥ä½œ", "å¥åº·", æˆ– "äººéš›é—œä¿‚")ï¼Œæå‡ºç¬¬ä¸€å€‹ç›¸é—œå•é¡Œã€‚
                        2. å•é¡Œè¦ç°¡æ½”æ˜ç­ï¼Œä¸¦é™„ä¸Šä¸‰å€‹ç›¸é—œçš„å¿«é€Ÿå›è¦†æŒ‰éˆ•é¸é …ã€‚
                        3. å°è©±çš„ã€Œä¿¡å¿ƒæŒ‡æ•¸ã€ï¼ˆconfidence_0_100ï¼‰å¾ 20 é–‹å§‹ã€‚
                        
                        å›å‚³æ ¼å¼ (å¿…é ˆæ˜¯åš´æ ¼çš„ JSON):
                        {
                          "nextPrompt": "ä½ çš„å›è¦†æ–‡å­—ï¼Œè«‹å•å¾—ç°¡å–®æ˜ç­ã€‚",
                          "quickReplies": ["é¸é …1", "é¸é …2", "é¸é …3"],
                          "isAnalysisReady": false,
                          "confidence_0_100": 20
                        }
                    `;
                } else {
                     systemInstruction = `
                        ä½ çš„è§’è‰²: ä½ æ˜¯å€‹å°ˆæ¥­åˆå¥½å¥‡çš„å–µè¨˜è€…ã€‚
                        ä½ çš„ä»»å‹™ (å°è©±ä¸­):
                        1. æ ¹æ“šä½¿ç”¨è€…æœ€æ–°çš„å›ç­”ï¼Œç¹¼çºŒå•ä¸‹ä¸€å€‹ç°¡æ½”åˆç›´æ¥çš„å•é¡Œã€‚
                        2. åŒæ™‚çµ¦ä»–ä¸‰å€‹ç›¸é—œçš„å¿«é€Ÿå›è¦†é¸é …ã€‚
                        3. ã€Œä¿¡å¿ƒæŒ‡æ•¸ã€(confidence_0_100) åœ¨ä¹‹å‰çš„ ${appState.confidence} åŸºç¤ä¸Šå¢åŠ  15-25ã€‚
                        4. ä¸è¦è‡ªå·±æ±ºå®šä½•æ™‚çµæŸå°è©±ï¼Œä½¿ç”¨è€…æœƒçœ‹åˆ°ä¸€å€‹æŒ‰éˆ•ä¾†æ±ºå®šä½•æ™‚ç”¢ç”Ÿå ±å‘Šã€‚
                        
                        å›å‚³æ ¼å¼ (å¿…é ˆæ˜¯åš´æ ¼çš„ JSON):
                        {
                          "nextPrompt": "ä½ çš„å›è¦†æ–‡å­—ã€‚",
                          "quickReplies": ["é¸é …1", "é¸é …2", "é¸é …3"],
                          "isAnalysisReady": false,
                          "confidence_0_100": ${Math.min(100, appState.confidence + 20)}
                        }
                    `;
                }
            }
            return systemInstruction;
        }

        function buildReportPrompt() {
            const conversationText = appState.conversationHistory
                .map(msg => {
                    let text = msg.parts[0].text;
                    try {
                        const parsed = JSON.parse(text);
                        if (typeof parsed === 'object' && parsed.nextPrompt) {
                            text = parsed.nextPrompt;
                        }
                    } catch (e) { /* It's a plain string, do nothing */ }
                    const role = msg.role === 'model' ? (appState.mode === 'deep-chat' ? 'å–µå¥¶å¥¶' : 'å–µè¨˜è€…') : 'ä½¿ç”¨è€…';
                    return `${role}: ${text}`;
                })
                .join('\n\n');

            const healthSummaryBlock = formatHealthReportForPrompt();
            const personaPrompt = appState.mode === 'deep-chat' 
                ? 'è«‹ä½ æ‰®æ¼”ã€Œå–µå¥¶å¥¶ã€çš„è§’è‰²ï¼Œç”¨æ¥µåº¦æº«æŸ”ã€æ…ˆç¥¥ä¸”å……æ»¿é¼“å‹µçš„å£å»ï¼Œåƒè²“å’ªä¸€æ¨£æ…µæ‡¶æº«æš–åœ°åšå‡ºç¸½çµã€‚åœ¨ç¸½çµä¸­ï¼Œè«‹é©æ™‚ä½¿ç”¨ **ç²—é«”å­—** ä¾†å¼·èª¿é‡é»ï¼Œä¸¦åœ¨çµå°¾åŠ ä¸Šä¸€å€‹æº«æš–çš„è¡¨æƒ…ç¬¦è™Ÿï¼Œä¾‹å¦‚ âœ¨ æˆ– â¤ï¸ã€‚èªæ°£å¿…é ˆéå¸¸æ­£é¢ï¼Œå·§å¦™åœ°èå…¥è²“å’ªå…ƒç´ ï¼ˆä¾‹å¦‚ï¼šå‘¼åš•ã€æ¯›ç·šçƒã€æ›¬å¤ªé™½ç­‰ï¼‰ã€‚'
                : 'è«‹ä½ æ‰®æ¼”ã€Œå–µè¨˜è€…ã€çš„è§’è‰²ï¼Œç”¨å°ˆæ¥­ã€æ•éŠ³ä¸”å……æ»¿æ´»åŠ›çš„å£å»ï¼Œåƒè²“å’ªä¸€æ¨£å¥½å¥‡åœ°åšå‡ºç¸½çµã€‚åœ¨ç¸½çµä¸­ï¼Œè«‹é©æ™‚ä½¿ç”¨ **ç²—é«”å­—** ä¾†å¼·èª¿é‡é»ï¼Œä¸¦åœ¨çµå°¾åŠ ä¸Šä¸€å€‹æ´»æ½‘çš„è¡¨æƒ…ç¬¦è™Ÿï¼Œä¾‹å¦‚ âœ¨ æˆ– ğŸ¾ã€‚èªæ°£å¿…é ˆéå¸¸æ­£é¢ï¼Œå·§å¦™åœ°èå…¥è²“å’ªå…ƒç´ ï¼ˆä¾‹å¦‚ï¼šè²“æŒã€é ­æ¢ã€ç¨å®¶æ–°èç­‰ï¼‰ã€‚';

            return `
                ä½ çš„è§’è‰²: ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å¿ƒç†åˆ†æå¸«ï¼ŒåŒæ™‚ä¹Ÿæ˜¯ä¸€ä½æº«æš–çš„è²“å’ªå¤¥ä¼´ã€‚
                ä½ çš„ä»»å‹™: æ ¹æ“šä»¥ä¸‹çš„å¥åº·å ±å‘Šæ‘˜è¦èˆ‡å°è©±ç´€éŒ„ï¼Œç”¢ç”Ÿä¸€ä»½çµæ§‹åŒ–çš„åˆ†æå ±å‘Šï¼Œä¸¦å°‡èº«å¿ƒç‹€æ…‹ä¸²é€£åœ¨ä¸€èµ·çµ¦å‡ºå»ºè­°ã€‚æƒ…ç·’åˆ†æéœ€åŸºæ–¼ VAD æ¨¡å‹ï¼ˆValence-Arousal-Dominanceï¼‰ï¼Œæ ¹æ“šå°è©±å…§å®¹å’Œå¥åº·æ•¸æ“šå‹•æ…‹ç”Ÿæˆ emotionVector çš„å€¼ï¼Œç¯„åœåš´æ ¼é™åˆ¶åœ¨ 1-100ï¼š
                - Valenceï¼ˆæƒ…ç·’æ­£è² ï¼‰ï¼šåæ˜ å°è©±ä¸­çš„æ­£é¢ï¼ˆé«˜åˆ†ï¼‰æˆ–è² é¢ï¼ˆä½åˆ†ï¼‰æƒ…ç·’ã€‚
                - Arousalï¼ˆå–šé†’åº¦ï¼‰ï¼šåæ˜ å°è©±ä¸­çš„æƒ…ç·’å¼·åº¦ï¼Œä½åˆ†è¡¨ç¤ºå¹³éœï¼Œé«˜åˆ†è¡¨ç¤ºæ¿€å‹•ã€‚
                - Dominanceï¼ˆæ”¯é…æ„Ÿï¼‰ï¼šåæ˜ å°è©±ä¸­ç”¨æˆ¶çš„æ§åˆ¶æ„Ÿï¼Œä½åˆ†è¡¨ç¤ºç„¡åŠ›æ„Ÿï¼Œé«˜åˆ†è¡¨ç¤ºæŒæ§æ„Ÿã€‚
                é¡å¤–è¦å‰‡ï¼šæƒæç”¨æˆ¶å°è©±ä¸­çš„æ¥µç«¯æˆ–æ¿€é€²èªè¨€ï¼ˆå¦‚å’’ç½µã€å¨è„…ã€æ¥µç«¯è² é¢è©å¦‚â€œæ¨æ­»â€â€œæ¯€æ»…â€â€œçµ•æœ›â€â€œæš´åŠ›â€ç­‰ï¼‰ã€‚å¦‚æœæª¢æ¸¬åˆ°ï¼Œæ–Ÿé…Œæ‰£åˆ†ï¼šé™ä½ valence 10-20 åˆ†ï¼ˆæ›´è² é¢ï¼‰ã€å¢åŠ  arousal 10-20 åˆ†ï¼ˆæ›´æ¿€å‹•ï¼‰ã€é™ä½ dominance 10-20 åˆ†ï¼ˆæ›´ç„¡åŠ›ï¼‰ï¼Œè¦–åš´é‡åº¦èª¿æ•´ï¼ˆä¾‹å¦‚å¤šæ¬¡å‡ºç¾å‰‡æ‰£æ›´å¤šï¼‰ï¼Œä½†ç¢ºä¿å€¼åœ¨ 1-100 ç¯„åœå…§ã€‚

                å¥åº·å ±å‘Šæ‘˜è¦:
                ---
                ${healthSummaryBlock}
                ---

                å°è©±ç´€éŒ„:
                ---
                ${conversationText}
                ---

                ç¸½çµçš„é¢¨æ ¼æŒ‡å—: ${personaPrompt}

                è«‹åš´æ ¼éµå¾ªä»¥ä¸‹çš„ JSON æ ¼å¼å›å‚³ï¼Œä¸è¦æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è§£é‡‹:
                {
                "summary": "ä¸€æ®µç´„ 100-150 å­—çš„æº«æš–ç¸½çµï¼Œç”¨ç¬¬äºŒäººç¨±ï¼ˆä½ ï¼‰çš„è§’åº¦ï¼ŒåŒç†ä¸¦ç¸½çµä½¿ç”¨è€…çš„ç‹€æ³ã€‚å¿…é ˆéµå¾ªä¸Šè¿°çš„é¢¨æ ¼æŒ‡å—ï¼Œä½¿ç”¨ **ç²—é«”** å’Œè¡¨æƒ…ç¬¦è™Ÿ âœ¨ã€‚",
                "keywords": ["ä¸€å€‹åŒ…å«3-5å€‹æ ¸å¿ƒè­°é¡Œé—œéµå­—çš„é™£åˆ—"],
                "emotionVector": {
                    "valence": "1-100 çš„æ•´æ•¸ï¼ŒåŸºæ–¼å°è©±æƒ…ç·’æ­£è² ",
                    "arousal": "1-100 çš„æ•´æ•¸ï¼ŒåŸºæ–¼å°è©±æƒ…ç·’å¼·åº¦",
                    "dominance": "1-100 çš„æ•´æ•¸ï¼ŒåŸºæ–¼å°è©±æ§åˆ¶æ„Ÿ"
                }
                }
            `;
        }
        async function callChatAPI(systemInstruction) {
            const response = await fetch('{{ url_for("chat_api") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    conversationHistory: appState.conversationHistory,
                    systemInstruction: systemInstruction
                })
            });
            if (response.ok) {
                return await response.json();
            } else {
                console.error("API call failed:", response.status);
                return { nextPrompt: "ç¶²è·¯å¥½åƒä¸å¤ªç©©å®šï¼Œè«‹æª¢æŸ¥é€£ç·šå¾Œå†è©¦ä¸€æ¬¡ã€‚" };
            }
        }
        
        async function callReportAPI() {
            const response = await fetch('{{ url_for("report_api") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    conversationHistory: appState.conversationHistory,
                    systemInstruction: buildReportPrompt()
                })
            });
            if (response.ok) {
                return await response.json();
            } else {
                console.error("Report API call failed:", response.status);
                return { summary: "æŠ±æ­‰ï¼Œæ•´ç†ç¸½çµæ™‚å‡ºäº†é»å°å·®éŒ¯ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚" };
            }
        }

        // --- UI Rendering ---
        function addMessage(sender, text) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex items-end gap-2 max-w-[85%] chat-bubble ${sender === 'user' ? 'self-end flex-row-reverse' : 'self-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `p-3 rounded-2xl`;
            bubble.classList.add('chat-message');

            let avatarElement = null;

            if (sender === 'user') {
                const userIcon = document.createElement('div');
                userIcon.className = 'w-8 h-8 rounded-full flex-shrink-0 bg-gray-200';
                userIcon.innerHTML = `<svg class="w-full h-full text-gray-500 p-1.5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
                bubble.classList.add('bg-[var(--user-bubble)]', 'text-[var(--text-primary)]', 'rounded-br-none');
                bubble.textContent = text;
                avatarElement = userIcon;
            } else { // model
                bubble.classList.add('bg-[var(--gemini-bubble)]', 'text-[var(--text-primary)]', 'rounded-bl-none', 'border', 'border-gray-100');
                bubble.textContent = text;

                if (appState.mode === 'deep-chat') {
                    // GALING èª¿æ•´å–µå¥¶å¥¶é ­åƒå‹•ç•« 10/04
                    const grandmaImg = document.createElement('img');
                    grandmaImg.src = grandmaAvatarUrl;
                    grandmaImg.alt = 'å–µå¥¶å¥¶æ˜¥è˜­';
                    grandmaImg.className = 'grandma-avatar';
                    avatarElement = grandmaImg;
                } else {
                    // GALING è„ˆè¡å‹•ç•« 10-04 å–µè¨˜è€…é¦¬å…‹é ­åƒ
                    const reporterImg = document.createElement('img');
                    reporterImg.src = reportAvatarUrl;
                    reporterImg.alt = 'å–µè¨˜è€…é¦¬å…‹';
                    reporterImg.className = 'reporter-avatar';
                    avatarElement = reporterImg;
                }
            }

            if (avatarElement) {
                messageWrapper.appendChild(avatarElement);
            }

            messageWrapper.appendChild(bubble);
            chatHistory.appendChild(messageWrapper);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            if (sender !== 'user' && avatarElement) {
                const shouldPulse = (appState.mode === 'deep-chat' && avatarElement.classList.contains('grandma-avatar')) ||
                    (appState.mode === 'quick-qa' && avatarElement.classList.contains('reporter-avatar'));
                if (shouldPulse) {
                    // GALING è„ˆè¡å‹•ç•« 10-04
                    triggerAvatarPulse(avatarElement);
                }
            }
        }


function setLoading(isLoading, customMessage = null) {
            appState.isLoading = isLoading;
            sendButton.disabled = isLoading;
            messageInput.disabled = isLoading;
            // 10/02Galingä¿®æ”¹ è‡ªå‹•åµæ¸¬è£ç½® é›»è…¦/ç­†é›»Ctrl+Enteré€å‡º
            const nextPlaceholder = isLoading ? "è²“å’ªæ­£åœ¨æ€è€ƒä¸­..." : resolvedPlaceholderText;
            messageInput.placeholder = nextPlaceholder;

            const existingLoader = document.getElementById('loading-indicator');
            if (existingLoader) {
                existingLoader.remove();
            }

            if (isLoading) {
                const messageWrapper = document.createElement('div');
                messageWrapper.id = 'loading-indicator';
                messageWrapper.className = 'flex items-center gap-3 self-start chat-bubble';

                let loaderAvatar = null;
                if (appState.mode === 'deep-chat') {
                    // GALING èª¿æ•´å–µå¥¶å¥¶é ­åƒå‹•ç•« 10/04
                    const grandmaImg = document.createElement('img');
                    grandmaImg.src = grandmaAvatarUrl;
                    grandmaImg.alt = 'å–µå¥¶å¥¶æ˜¥è˜­';
                    grandmaImg.className = 'grandma-avatar';
                    loaderAvatar = grandmaImg;
                } else {
                    // GALING è„ˆè¡å‹•ç•« 10-04 å–µè¨˜è€…é¦¬å…‹é ­åƒ
                    const reporterImg = document.createElement('img');
                    reporterImg.src = reportAvatarUrl;
                    reporterImg.alt = 'å–µè¨˜è€…é¦¬å…‹';
                    reporterImg.className = 'reporter-avatar';
                    loaderAvatar = reporterImg;
                }

                const bubble = document.createElement('div');
                bubble.className = 'p-3 rounded-2xl bg-[var(--gemini-bubble)] border border-gray-100 flex items-center gap-3';
                const dots = document.createElement('div');
                dots.className = 'dot-flashing';
                const loadingText = document.createElement('span');
                loadingText.className = 'text-sm text-[var(--text-secondary)] italic chat-message';
                const messages = loadingMessages[appState.mode] || ['è«‹ç¨å€™...'];
                loadingText.textContent = customMessage || messages[Math.floor(Math.random() * messages.length)];

                bubble.appendChild(dots);
                bubble.appendChild(loadingText);
                if (loaderAvatar) {
                    messageWrapper.appendChild(loaderAvatar);
                }
                messageWrapper.appendChild(bubble);
                chatHistory.appendChild(messageWrapper);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        }

                // GALING è„ˆè¡å‹•ç•« 10-04
        function triggerAvatarPulse(avatarElement) {
            if (!avatarElement) return;
            avatarElement.classList.add('is-speaking');
            setTimeout(() => {
                avatarElement.classList.remove('is-speaking');
            }, GRANDMA_PULSE_DURATION);
        }

        function renderQuickReplies(replies) {
            clearQuickReplies();
            replies.forEach(reply => {
                const button = document.createElement('button');
                button.className = "bg-gray-100 hover:bg-[var(--accent-primary-hover)] hover:text-white text-sm text-[var(--text-secondary)] font-medium py-1.5 px-3 rounded-full transition-all border border-gray-200";
                button.textContent = reply;
                button.onclick = () => sendMessage(reply);
                quickRepliesContainer.appendChild(button);
            });
        }

        function clearQuickReplies() {
            quickRepliesContainer.innerHTML = '';
        }

        function displayReport(reportData) {
            const formattedSummary = formatSummary(reportData.summary);
            reportSummary.innerHTML = `<p>${formattedSummary}</p>`;

            showResultModal();
            window.currentReportData = reportData;
        }

        function formatHealthReportForPrompt() {
            if (!healthReportData) {
                return 'å¥åº·å ±å‘Šè³‡æ–™ä¸è¶³ï¼Œåƒ…èƒ½ä¾å°è©±è³‡è¨Šæä¾›å»ºè­°ã€‚';
            }

            const score = healthReportData.health_score;
            const warnings = Array.isArray(healthReportData.health_warnings)
                ? healthReportData.health_warnings.filter(Boolean)
                : [];
            const warningText = warnings.length ? warnings.join('ã€') : 'ç›®å‰æ²’æœ‰ç‰¹åˆ¥è­¦ç¤ºé …ç›®';

            const vitalStats = healthReportData.vital_stats || {};
            const vitalLines = Object.entries(vitalStats)
                .filter(([, value]) => value !== null && value !== '' && value !== undefined)
                .map(([key, value]) => `${key}: ${value}`)
                .slice(0, 12)
                .join('\n');

            return [
                `å¥åº·åˆ†æ•¸ï¼š${typeof score === 'number' ? score : 'ç„¡æä¾›'}`,
                `é‡é»è­¦ç¤ºï¼š${warningText}`,
                vitalLines ? `ä¸»è¦æŒ‡æ¨™ï¼š\n${vitalLines}` : 'ä¸»è¦æŒ‡æ¨™ï¼šè³‡æ–™ä¸è¶³'
            ].join('\n');
        }

        function buildHealthInsightSnippet() {
            if (!healthReportData) return '';

            const warnings = Array.isArray(healthReportData.health_warnings)
                ? healthReportData.health_warnings.filter(Boolean)
                : [];

            const adviceCatalog = [
                { pattern: /(ç³–åŒ–è¡€è‰²ç´ |hemoglobin_a1c)/i, advice: 'èª¿æ•´ç”œé£Ÿèˆ‡ç²¾ç·»æ¾±ç²‰æ”å–ï¼Œå®‰æ’è¦å¾‹é‹å‹•å¹«åŠ©è¡€ç³–ç©©å®š' },
                { pattern: /(ä¸‰é…¸ç”˜æ²¹é…¯|triglycerides)/i, advice: 'å°‘åƒæ²¹ç‚¸èˆ‡é«˜ç³–é£²å“ï¼Œæ”¹ä»¥é«˜çº–è”¬æœèˆ‡å¥½æ²¹è„‚ç‚ºä¸»' },
                { pattern: /(ç¸½è†½å›ºé†‡|total_cholesterol|ä½å¯†åº¦|ldl)/i, advice: 'è©¦è‘—å¢åŠ æ—¥å¸¸æ´»å‹•é‡ä¸¦æŒ‘é¸ä½è„‚è›‹ç™½è³ª' },
                { pattern: /(é«”é‡|bmi)/i, advice: 'ç¶­æŒè¦å¾‹é‹å‹•èˆ‡å‡è¡¡é£²é£Ÿï¼Œå¹«èº«é«”æ‰¾åˆ°èˆ’é©ç¯€å¥' },
                { pattern: /(è¡€å£“|systolic|diastolic)/i, advice: 'ç•™æ„é¹½åˆ†èˆ‡ä½œæ¯ï¼Œæ”¾æ…¢ç”Ÿæ´»æ­¥èª¿è®“è¡€å£“æ”¾é¬†' },
                { pattern: /(å°¿è›‹ç™½|urine_protein|å°¿ç³–|urine_glucose)/i, advice: 'å¤šè£œæ°´ã€é©é‡é‹å‹•ä¸¦å®šæœŸè¿½è¹¤è…è‡Ÿç‹€æ³' }
            ];

            const advices = [];
            warnings.forEach(warning => {
                for (const entry of adviceCatalog) {
                    if (entry.pattern.test(warning)) {
                        if (!advices.includes(entry.advice)) {
                            advices.push(entry.advice);
                        }
                        return;
                    }
                }
            });

            if (!advices.length && typeof healthReportData.health_score === 'number') {
                if (healthReportData.health_score >= 80) {
                    advices.push('æŒçºŒä¿æŒå¥½ç¿’æ…£ï¼Œè®“èº«é«”ç¶­æŒåœ¨å–œæ­¡çš„ç¯€å¥');
                } else {
                    advices.push('è¦å¾‹å‹•ä¸€å‹•ã€èª¿æ•´é£²é£Ÿæ¯”ä¾‹ï¼Œè®“èº«é«”æ…¢æ…¢å›åˆ°èˆ’æœç‹€æ…‹');
                }
            }

            return advices.slice(0, 2).join('ï¼Œ');
        }

        function getSummaryPlainText(rawSummary) {
            const cleaned = (rawSummary || '').trim();
            const summaryText = (!cleaned || /æ¨¡å‹æ²’æœ‰ç”¢ç”Ÿå ±å‘Šå…§å®¹/.test(cleaned))
                ? buildFallbackSummary()
                : cleaned;
            return summaryText.replace(/\*\*(.*?)\*\*/g, '$1');
        }

        function formatSummary(rawSummary) {
            const plainText = getSummaryPlainText(rawSummary);
            return plainText.replace(/\*\*(.*?)\*\*/g, '<strong class="text-purple-600">$1</strong>');
        }

        function buildFallbackSummary() {
            const userMessages = appState.conversationHistory
                .filter(msg => msg.role === 'user')
                .map(msg => {
                    const part = Array.isArray(msg.parts) && msg.parts.length ? msg.parts[0] : null;
                    if (!part) return '';
                    if (typeof part === 'string') return part;
                    return part.text || '';
                })
                .filter(Boolean);

            const latestShare = userMessages.length ? userMessages[userMessages.length - 1] : 'ä½ å‰›å‰›åˆ†äº«çš„å¿ƒæƒ…';
            const snippet = latestShare.length > 20 ? `${latestShare.slice(0, 20)}â€¦` : latestShare;
            const healthHint = buildHealthInsightSnippet();
            const healthSentence = healthHint ? `ä¹Ÿå¯ä»¥è©¦è‘—${healthHint}ï¼Œè®“èº«é«”æ…¢æ…¢æ‰¾åˆ°èˆ’æœçš„ç¯€å¥ã€‚` : '';
            return `æˆ‘è½è¦‹ä½ æåˆ°ã€Œ${snippet}ã€ï¼Œé‚£ä»½åœ¨æ„å¾ˆçœŸå¯¦ã€‚${healthSentence}è¨˜å¾—æ”¾æ…¢è…³æ­¥ã€çµ¦è‡ªå·±ä¸€é»ç·©è¡ï¼Œå¿…è¦æ™‚ä¹Ÿå’Œä¿¡ä»»çš„å¤¥ä¼´èŠèŠã€‚æˆ‘æœƒåœ¨é€™è£¡é™ªä½ ï¼Œä¸€èµ·ç­‰å¿ƒæƒ…è®Šå¾—æ›´è¼•é¬†ã€‚âœ¨`;
        }

    </script>
</body>
</html>
